<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOD Generator | COACH CHRIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-page: #f3f4f6;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-heading: #000000;
            --text-muted: #9ca3af;
            --text-accent: #6b7280;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --bg-toggle: #f3f4f6;
            --toggle-pill-bg: #e5e7eb;
            --bg-btn-primary: #000000;
            --btn-text-primary: #ffffff;
            --bg-output: #f9fafb;
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --launch-overlay: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] {
            --bg-page: #0a0a0a;
            --bg-card: #121212;
            --border-color: #262626;
            --text-main: #ffffff;
            --text-heading: #ffffff;
            --text-muted: #525252;
            --text-accent: #a3a3a3;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            --bg-toggle: #1a1a1a;
            --toggle-pill-bg: #1a1a1a;
            --bg-btn-primary: #ffffff;
            --btn-text-primary: #000000;
            --bg-output: #1a1a1a;
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --launch-overlay: rgba(10, 10, 10, 0.95);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .font-brand { font-family: 'Oswald', sans-serif; }

        .app-card {
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .theme-switch-container {
            position: relative;
            width: 44px;
            height: 22px;
            background-color: var(--toggle-pill-bg);
            border-radius: 100px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 2px;
            border: 1px solid var(--border-color);
        }

        .theme-switch-circle {
            position: absolute;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: var(--bg-btn-primary);
            border-radius: 50%;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        [data-theme="dark"] .theme-switch-circle { transform: translateX(22px); }

        .kit-option {
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .kit-option input { display: none; }
        .kit-option:has(input:checked) {
            background-color: var(--bg-btn-primary);
            color: var(--btn-text-primary);
            border-color: var(--bg-btn-primary);
        }

        #wod-movements {
            background-color: var(--bg-output);
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .movement-line {
            display: block;
            line-height: 2.4;
            border-bottom: 1px solid var(--border-color);
            padding: 4px 0;
        }
        .movement-line:last-child { border-bottom: none; }

        .kit-tag {
            background-color: var(--bg-toggle);
            color: var(--text-heading);
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-generate {
            background-color: var(--bg-btn-primary);
            color: var(--btn-text-primary);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .btn-generate:active { transform: scale(0.98) translateY(0); }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background-color: var(--modal-overlay);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
            max-width: 24rem;
            border-radius: 2rem;
            padding: 2rem;
            position: relative;
        }
        
        .modal-overlay.active .modal-content { transform: scale(1); }

        #launch-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: var(--launch-overlay);
            backdrop-filter: blur(12px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #launch-overlay.active { display: flex; opacity: 1; }

        #launch-icon-container {
            color: var(--text-heading);
            animation: pulse-scale 1.2s infinite ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes pulse-scale {
            0% { transform: scale(0.85); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.85); opacity: 0.3; }
        }

        .hidden-initial { display: none; }

        .baseline-badge {
            background-color: var(--bg-btn-primary);
            color: var(--btn-text-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4" data-theme="light">

    <div id="launch-overlay">
        <div id="launch-icon-container">
            <i data-lucide="zap" class="w-16 h-16"></i>
        </div>
        <p id="loading-text" class="mt-4 font-brand font-bold text-xl uppercase tracking-widest text-center px-8" style="color: var(--text-heading)">Preparing Session</p>
    </div>

    <!-- HELP MODAL -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content shadow-2xl">
            <button id="close-modal" class="absolute top-6 right-6 p-2 rounded-full hover:opacity-70 transition-opacity" style="color: var(--text-muted)">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="flex flex-col items-center text-center">
                <div class="p-4 rounded-2xl mb-4" style="background-color: var(--bg-toggle)">
                    <i data-lucide="help-circle" class="w-8 h-8" style="color: var(--text-heading)"></i>
                </div>
                <h3 class="font-brand font-bold text-2xl uppercase mb-3" style="color: var(--text-heading)">How it Works</h3>
                <div class="space-y-4 text-sm leading-relaxed text-left" style="color: var(--text-accent)">
                    <p>This tool generates custom workouts based on the equipment you have available right now.</p>
                    <ul class="space-y-3 list-none">
                        <li class="flex gap-3">
                            <i data-lucide="shield" class="w-5 h-5 mt-0.5 flex-shrink-0" style="color: var(--text-heading)"></i>
                            <span><strong>Always Included:</strong> Bodyweight fundamentals are the base of every session.</span>
                        </li>
                        <li class="flex gap-3">
                            <i data-lucide="layers" class="w-5 h-5 mt-0.5 flex-shrink-0" style="color: var(--text-heading)"></i>
                            <span><strong>Select Gear:</strong> Choose supplemental kit to expand the movement pool.</span>
                        </li>
                    </ul>
                </div>
                <button id="modal-confirm" class="w-full mt-8 py-3 font-black uppercase tracking-widest rounded-xl text-xs" style="background-color: var(--bg-btn-primary); color: var(--btn-text-primary)">Understood</button>
            </div>
        </div>
    </div>

    <div class="app-card w-full max-w-md rounded-[2.5rem] overflow-hidden flex flex-col items-center p-8 space-y-8">
        
        <header class="w-full flex justify-between items-start">
            <div class="flex flex-col select-none">
                <h1 class="font-brand font-bold text-4xl leading-none tracking-wide mb-1" style="color: var(--text-heading)">COACH CHRIS</h1>
                <h2 class="font-brand font-bold text-lg leading-none mb-[2px]" style="color: var(--text-accent)">CIRCULAR ROOTS COACHING</h2>
                <h3 class="font-brand font-bold text-lg leading-none uppercase" style="color: var(--text-muted)">Train Uncnvntnl</h3>
            </div>
            
            <div class="flex flex-col items-center gap-3">
                <div class="flex flex-col items-center gap-1.5">
                    <span class="text-[9px] font-black uppercase tracking-widest opacity-60" style="color: var(--text-muted)">Theme</span>
                    <div id="theme-toggle" class="theme-switch-container">
                        <div class="theme-switch-circle"></div>
                    </div>
                </div>
                <button id="open-info" class="p-2 rounded-xl transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center" style="background-color: var(--bg-toggle); color: var(--text-heading)" title="How to use">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- SETUP SCREEN -->
        <div id="home-state" class="w-full text-center space-y-6 py-4 animate-in fade-in duration-700">
            <div class="space-y-2">
                <h2 class="font-brand font-bold text-4xl uppercase tracking-tight" style="color: var(--text-heading)">WOD Generator</h2>
                <p class="text-xs font-bold uppercase tracking-widest px-4 py-2 flex items-center justify-center gap-2 rounded-full mx-auto w-fit" style="background-color: var(--bg-toggle); color: var(--text-accent)">
                    <i data-lucide="clock" class="w-3 h-3"></i> 15 - 30 MIN SESSIONS
                </p>
            </div>
            
            <div class="rounded-3xl p-6 border border-dashed space-y-4" style="background-color: var(--bg-toggle); border-color: var(--border-color)">
                
                <div class="space-y-4">
                    <div class="baseline-badge p-4 rounded-2xl flex items-center justify-between border-2 border-transparent">
                        <div class="flex flex-col items-start">
                            <span class="text-xs font-bold uppercase tracking-widest">Bodyweight Foundation</span>
                            <span class="text-[9px] font-black opacity-60 uppercase tracking-tighter">Included in every session</span>
                        </div>
                        <i data-lucide="shield" class="w-5 h-5"></i>
                    </div>

                    <div class="flex items-center gap-3 pt-1">
                        <div class="h-[1px] flex-1 bg-gray-300 dark:bg-gray-700"></div>
                        <span class="text-[10px] font-black uppercase tracking-widest opacity-40">Add Supplemental Kit</span>
                        <div class="h-[1px] flex-1 bg-gray-300 dark:bg-gray-700"></div>
                    </div>

                    <div class="grid grid-cols-1 gap-2">
                        <label class="kit-option p-4 rounded-2xl text-[11px] font-bold uppercase tracking-wider">
                            <input type="checkbox" name="kit-select" value="kettlebell" checked>
                            Single Kettlebell
                        </label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="kit-option p-4 rounded-2xl text-[11px] font-bold uppercase tracking-wider">
                                <input type="checkbox" name="kit-select" value="run">
                                Run Space
                            </label>
                            <label class="kit-option p-4 rounded-2xl text-[11px] font-bold uppercase tracking-wider">
                                <input type="checkbox" name="kit-select" value="pullup">
                                Pull Up Bar
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="wod-card" class="w-full space-y-5 hidden-initial opacity-0 transition-opacity duration-500">
            
            <div class="flex items-center justify-between">
                <div id="kit-section" class="space-y-2">
                    <span class="text-[10px] font-black uppercase tracking-widest" style="color: var(--text-muted)">Kit Required For This Plan</span>
                    <div id="kit-container" class="flex flex-wrap gap-2"></div>
                </div>
                <button id="reset-button" class="p-2.5 rounded-2xl transition-all duration-300 hover:scale-105 active:scale-95 flex items-center justify-center border border-dashed" style="background-color: var(--bg-toggle); color: var(--text-accent); border-color: var(--border-color)">
                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="flex items-center justify-between border-b pb-2" style="border-color: var(--border-color)">
                <h3 class="text-xs font-black uppercase tracking-widest" style="color: var(--text-muted)">Your Session Plan</h3>
            </div>

            <div class="space-y-4">
                <div class="flex flex-col gap-1">
                    <span id="wod-format-name" class="text-3xl font-black uppercase tracking-tighter leading-none" style="color: var(--text-heading)"></span>
                    <span id="wod-format-desc" class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-accent)"></span>
                </div>

                <div id="wod-movements" class="w-full p-5 rounded-3xl text-sm md:text-base"></div>

                <div class="flex items-center justify-between">
                    <div id="wod-time-cap" class="text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full" style="background-color: var(--bg-toggle); color: var(--text-heading)"></div>
                    <button id="copy-button" class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest hover:opacity-70 transition-opacity" style="color: var(--text-accent)">
                        <i data-lucide="copy" class="w-3 h-3"></i> Share Effort
                    </button>
                </div>
            </div>

            <div id="instructional-section" class="pt-6 border-t space-y-4" style="border-color: var(--border-color)">
                <h3 class="text-xs font-black uppercase tracking-widest" style="color: var(--text-muted)">Execution Strategy</h3>
                <div id="instruction-content" class="space-y-3"></div>
            </div>
        </div>

        <button id="generate-button" class="btn-generate w-full py-5 font-brand font-bold text-xl uppercase tracking-widest rounded-3xl shadow-lg">
            Build My Session
        </button>
    </div>

    <script type="module">
        lucide.createIcons();

        const PILLARS = {
            full_body: [
                { name: "SA KB Long Cycle", type: "power", unilateral: "switch", baseReps: 8, kit: "kettlebell", conflicts: ["press"] },
                { name: "SA KB Thrusters", type: "power", unilateral: "switch", baseReps: 10, kit: "kettlebell", conflicts: ["press"] },
                { name: "SA KB Cluster", type: "power", unilateral: "switch", baseReps: 6, kit: "kettlebell" },
                { name: "Burpees", type: "cardio", unilateral: null, baseReps: 12, kit: "bodyweight" },
                { name: "SA KB Clean & Press", type: "power", unilateral: "switch", baseReps: 8, kit: "kettlebell", conflicts: ["press"] },
                { name: "SA KB Snatches", type: "power", unilateral: ["alt", "switch"], baseReps: 10, kit: "kettlebell" },
                { name: "SA KB Cleans", type: "power", unilateral: "switch", baseReps: 12, kit: "kettlebell" },
                { name: "KB Turkish Get-Ups", type: "skill", unilateral: "switch", baseReps: 2, kit: "kettlebell", slowMovement: true }
            ],
            upper: [
                { name: "SA KB Push Press", type: "strength", unilateral: "switch", baseReps: 10, kit: "kettlebell", conflicts: ["press"] },
                { name: "SA KB Strict Press", type: "strength", unilateral: "switch", baseReps: 8, kit: "kettlebell", conflicts: ["press"] },
                { name: "Push-ups", type: "strength", unilateral: null, baseReps: 15, kit: "bodyweight" },
                { name: "SA KB Row", type: "strength", unilateral: "switch", baseReps: 12, kit: "kettlebell" },
                { name: "SA KB Floor Press", type: "strength", unilateral: "switch", baseReps: 12, kit: "kettlebell" },
                { name: "Pike Push-ups", type: "strength", unilateral: null, baseReps: 8, kit: "bodyweight" },
                { name: "Pull Ups", type: "strength", unilateral: null, baseReps: 8, kit: "pullup", conflicts: ["vertical-pull"] }
            ],
            lower: [
                { name: "KB Goblet Squats", type: "strength", unilateral: null, baseReps: 15, kit: "kettlebell" },
                { name: "2H KB Swings", type: "power", unilateral: null, baseReps: 20, kit: "kettlebell" },
                { name: "SA KB Swings", type: "power", unilateral: "switch", baseReps: 16, kit: "kettlebell" },
                { name: "KB Goblet Lunges", type: "strength", unilateral: "alt", baseReps: 16, kit: "kettlebell" },
                { name: "Reverse Lunges", type: "strength", unilateral: "alt", baseReps: 20, kit: "bodyweight" },
                { name: "Air Squats", type: "strength", unilateral: null, baseReps: 25, kit: "bodyweight" }
            ],
            core: [
                { name: "SA KB Plank Drags", type: "stability", unilateral: "alt", baseReps: 12, kit: "kettlebell" },
                { name: "KB Windmills", type: "skill", unilateral: "switch", baseReps: 5, kit: "kettlebell" },
                { name: "Hanging Leg Raises", type: "stability", unilateral: null, baseReps: 12, kit: "pullup" },
                { name: "Quadruped Shoulder Taps", type: "stability", unilateral: "alt", baseReps: 20, kit: "bodyweight" },
                { name: "Plank Shoulder Taps", type: "stability", unilateral: "alt", baseReps: 30, kit: "bodyweight" },
                { name: "Dead Bugs", type: "stability", unilateral: "alt", baseReps: 16, kit: "bodyweight" },
                { name: "Sit-ups", type: "stability", unilateral: null, baseReps: 20, kit: "bodyweight" },
                { name: "Hollow Body Holds", type: "stability", unilateral: null, baseReps: 30, kit: "bodyweight", isTimeBased: true }
            ],
            conditioning: [
                { name: "Run 400m", type: "distance", unilateral: null, baseReps: 1, kit: "run" },
                { name: "SA KB Snatches", type: "power", unilateral: ["alt", "switch"], baseReps: 12, kit: "kettlebell" },
                { name: "2H KB Swings", type: "power", unilateral: null, baseReps: 30, kit: "kettlebell" },
                { name: "Mountain Climbers", type: "cardio", unilateral: "alt", baseReps: 40, kit: "bodyweight" },
                { name: "Jump Squats", type: "power", unilateral: null, baseReps: 12, kit: "bodyweight" }
            ]
        };

        const FORMATS = [
            { 
                name: "AMRAP", 
                style: "Aerobic Capacity & Pacing", 
                howTo: [
                    "Start your timer. Perform movement A, then B, then C, etc., for the prescribed reps.",
                    "Once the final movement in the list is finished, immediately return to movement A.",
                    "The goal is to complete as many full cycles as possible before the timer hits 0.",
                    "Minimize transition time between exercises. Nasal breathe as long as you can."
                ],
                generator: () => `TIME CAP: ${[15, 18, 20, 25, 30][Math.floor(Math.random() * 5)]} MINUTES` 
            }, 
            { 
                name: "ROUNDS FOR TIME", 
                style: "High Intensity & Benchmark", 
                howTo: [
                    "Perform the entire list of movements in order. This equals ONE round.",
                    "Repeat this cycle for the total number of rounds specified.",
                    "Stop your clock once the final rep of the final round is complete.",
                    "Rest only when required to maintain safe technique."
                ],
                generator: () => `${[3, 4, 5][Math.floor(Math.random() * 3)]} ROUNDS (${[15, 20, 25, 30][Math.floor(Math.random() * 4)]}m CAP)` 
            },
            { 
                name: "EMOM", 
                style: "Skill & Power", 
                howTo: [
                    "Minute 1: Perform Movement A. Rest for the remainder of that minute.",
                    "Minute 2: Perform Movement B. Rest for the remainder.",
                    "Continue rotating through the list on each subsequent minute.",
                    "The prescribed reps should allow for roughly 15-20 seconds of rest per minute."
                ],
                generator: () => `DURATION: ${[15, 20, 25, 30][Math.floor(Math.random() * 4)]} MINUTES` 
            },
            { 
                name: "CHIPPER", 
                style: "Resilience", 
                howTo: [
                    "Complete all reps for Movement A before looking at Movement B.",
                    "Once A is finished, move to B and complete all reps, then C, and so on.",
                    "Work through the list until the very last rep of the last exercise is done.",
                    "Break large sets into smaller blocks (e.g., sets of 5 or 10) with short rests."
                ],
                generator: () => `COMPLETION TIME (${[20, 25, 30][Math.floor(Math.random() * 3)]}m CAP)` 
            },
            { 
                name: "TABATA", 
                style: "Metabolic Threshold", 
                howTo: [
                    "Focus on Movement A: Work 20s, Rest 10s. Repeat for 8 total rounds (4 mins).",
                    "Rest 1 minute, then repeat the same 8-round protocol for Movement B.",
                    "Repeat for all movements in the plan.",
                    "Effort should be maximal within the 20-second work windows."
                ],
                generator: () => `DURATION: ${[16, 20, 24, 28][Math.floor(Math.random() * 4)]} MINUTES` 
            },
            { 
                name: "INTERVALS", 
                style: "Aerobic Power & Recovery", 
                howTo: [
                    "Work for the specified duration (e.g. 60s) on Movement A, then rest for the same duration.",
                    "Next, work on Movement B, then rest. Repeat through the list.",
                    "The rest is as long as the workâ€”maintain high power output during the work phase.",
                    "Cycle through the exercises until the total duration is reached."
                ],
                generator: (randType) => { return `${randType} (${[16, 20, 24, 30][Math.floor(Math.random() * 4)]} MINS)`; } 
            }
        ];

        const COACH_PHRASES = ["Calculating stimulus...", "Building foundation...", "Finding the limit...", "Setting intention..."];

        const body = document.body;
        const themeToggle = document.getElementById('theme-toggle');
        const generateButton = document.getElementById('generate-button');
        const resetButton = document.getElementById('reset-button');
        const copyButton = document.getElementById('copy-button');
        const wodCard = document.getElementById('wod-card');
        const homeState = document.getElementById('home-state');
        const wodFormatName = document.getElementById('wod-format-name');
        const wodFormatDesc = document.getElementById('wod-format-desc');
        const wodMovements = document.getElementById('wod-movements');
        const wodTimeCap = document.getElementById('wod-time-cap');
        const instructionContent = document.getElementById('instruction-content');
        const kitContainer = document.getElementById('kit-container');
        const launchOverlay = document.getElementById('launch-overlay');
        const loadingText = document.getElementById('loading-text');

        themeToggle.addEventListener('click', () => {
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        });

        function calculateReps(move, formatName, intervalType = null) {
            const { baseReps, type, unilateral, isTimeBased } = move;
            let finalReps = baseReps;
            const activeUnilateral = Array.isArray(unilateral) ? activeUnilateralArr(unilateral) : unilateral;

            // Specific Interval Format Rule (30/30 or 60/60)
            if (formatName === "INTERVALS" && intervalType) {
                const seconds = intervalType.includes("30s") ? "30" : "60";
                const tag = activeUnilateral === 'alt' ? ' (Alt)' : activeUnilateral === 'switch' ? ' (Switch Half)' : '';
                return `Reps for ${seconds}s${tag}`;
            }

            if (isTimeBased) {
                if (formatName === "TABATA" || formatName === "INTERVALS") return "Hold Position";
                if (formatName === "CHIPPER") return "60 Seconds";
                return `${baseReps} Seconds`;
            }

            if (formatName === "EMOM") {
                if (type === "distance") return "Full Period";
                finalReps = Math.ceil(baseReps * 0.85);
            } else if (formatName === "TABATA") {
                return "Max Reps (20s)";
            } else if (formatName === "CHIPPER") {
                if (type === "distance") return "Complete Once";
                finalReps = type === "power" ? 30 : 50;
                if (move.name.includes("Turkish")) finalReps = 10;
                if (move.name.includes("Long Cycle")) finalReps = 40;
                if (move.name.includes("Dead Bug") || move.name.includes("Shoulder Tap")) finalReps = 60;
                if (move.name.includes("Leg Raise")) finalReps = 30;
            } else if (type === "distance") {
                return "Distance Focus";
            }

            if (activeUnilateral && typeof finalReps === 'number') {
                if (finalReps % 2 !== 0) finalReps++; 
                const tag = activeUnilateral === 'alt' ? ' (Alt)' : activeUnilateral === 'switch' ? ' (Switch Half)' : '';
                return `${finalReps}${tag}`;
            }
            return finalReps;
        }

        function activeUnilateralArr(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function generateWOD() {
            const selectedKit = Array.from(document.querySelectorAll('input[name="kit-select"]:checked')).map(cb => cb.value);
            const activePoolKits = ["bodyweight", ...selectedKit];

            loadingText.textContent = COACH_PHRASES[Math.floor(Math.random() * COACH_PHRASES.length)];
            generateButton.disabled = true;
            launchOverlay.classList.add('active');
            
            setTimeout(() => {
                const format = FORMATS[Math.floor(Math.random() * FORMATS.length)];
                let kitActuallyUsed = new Set(); 
                let activeConflicts = new Set();
                
                // Pre-calculate Interval Type if needed
                let intervalType = null;
                if (format.name === "INTERVALS") {
                    intervalType = Math.random() > 0.5 ? "30s WORK / 30s REST" : "60s WORK / 60s REST";
                }

                wodFormatName.textContent = format.name;
                wodTimeCap.textContent = format.name === "INTERVALS" ? format.generator(intervalType) : format.generator();
                wodMovements.innerHTML = '';

                let moveIndex = 0;
                Object.keys(PILLARS).forEach(cat => {
                    const pool = PILLARS[cat].filter(m => {
                        if (m.kit !== "bodyweight" && !activePoolKits.includes(m.kit)) return false;
                        if (!format.allowDistance && m.type === "distance") return false;
                        if (!format.allowSlow && m.slowMovement) return false; 
                        if (m.conflicts && m.conflicts.some(c => activeConflicts.has(c))) return false;
                        return true;
                    });
                    
                    if (pool.length > 0) {
                        let moveObj = pool[Math.floor(Math.random() * pool.length)];
                        kitActuallyUsed.add(moveObj.kit);
                        if (moveObj.conflicts) moveObj.conflicts.forEach(c => activeConflicts.add(c));
                        
                        const displayReps = calculateReps(moveObj, format.name, intervalType);
                        const label = String.fromCharCode(65 + moveIndex);
                        
                        const line = document.createElement('div');
                        line.className = 'movement-line';
                        line.innerHTML = `<span>${label})</span> <strong>${moveObj.name.toUpperCase()}</strong> : <em>${displayReps}</em>`;
                        wodMovements.appendChild(line);
                        moveIndex++;
                    }
                });

                kitContainer.innerHTML = '';
                kitActuallyUsed.forEach(k => {
                    const l = k === 'kettlebell' ? 'Single KB' : k === 'run' ? 'Run Space' : k === 'pullup' ? 'Pull Up Bar' : 'Bodyweight';
                    const tag = document.createElement('div');
                    tag.className = 'kit-tag';
                    tag.innerHTML = `<i data-lucide="check-circle" class="w-3 h-3"></i> ${l}`;
                    kitContainer.appendChild(tag);
                });

                wodFormatDesc.textContent = format.name === "ROUNDS FOR TIME" ? "Fixed volume task execution" : format.name === "AMRAP" ? "As Many Rounds As Possible" : format.name === "EMOM" ? "Every Minute on the Minute" : format.name === "CHIPPER" ? "Single circuit high volume" : format.name === "TABATA" ? "Interval conditioning" : "1:1 Work to Rest Ratio";
                
                instructionContent.innerHTML = '';
                
                // Focus Header Box
                const styleBox = document.createElement('div');
                styleBox.className = 'flex items-center gap-2 p-3 rounded-xl mb-3 text-[10px] font-black uppercase tracking-widest';
                styleBox.style.backgroundColor = 'var(--bg-btn-primary)';
                styleBox.style.color = 'var(--btn-text-primary)';
                styleBox.innerHTML = `<i data-lucide="target" class="w-4 h-4"></i> Focus: ${format.style}`;
                instructionContent.appendChild(styleBox);

                // Step-by-Step Boxes (The Grey Boxes)
                format.howTo.forEach(text => {
                    const p = document.createElement('p');
                    p.className = 'p-3 rounded-xl text-[11px] leading-relaxed border border-dashed mb-2';
                    p.style.backgroundColor = 'var(--bg-toggle)';
                    p.style.borderColor = 'var(--border-color)';
                    p.style.color = 'var(--text-accent)';
                    p.textContent = text;
                    instructionContent.appendChild(p);
                });

                homeState.classList.add('hidden');
                wodCard.classList.remove('hidden-initial');
                launchOverlay.classList.remove('active');
                
                setTimeout(() => {
                    wodCard.classList.remove('opacity-0');
                    generateButton.textContent = "BUILD ANOTHER SESSION";
                    generateButton.disabled = false;
                    lucide.createIcons();
                }, 50);
            }, 800);
        }

        generateButton.addEventListener('click', generateWOD);
        resetButton.addEventListener('click', () => {
            wodCard.classList.add('opacity-0');
            setTimeout(() => {
                wodCard.classList.add('hidden-initial');
                homeState.classList.remove('hidden');
                generateButton.textContent = "Build My Session";
            }, 300);
        });

        copyButton.addEventListener('click', () => {
            const cleanMovements = Array.from(wodMovements.querySelectorAll('.movement-line')).map(l => l.innerText).join('\n');
            const text = `WOD: ${wodFormatName.textContent}\n${cleanMovements}\n\n${wodTimeCap.textContent}\n\nCOACH CHRIS`;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            copyButton.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> COPIED`;
            setTimeout(() => { copyButton.innerHTML = `<i data-lucide="copy" class="w-3 h-3"></i> Share Effort`; lucide.createIcons(); }, 1500);
        });

        const openModal = document.getElementById('open-info');
        const closeModal = document.getElementById('close-modal');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalOverlay = document.getElementById('modal-overlay');

        openModal.addEventListener('click', () => modalOverlay.classList.add('active'));
        closeModal.addEventListener('click', () => modalOverlay.classList.remove('active'));
        modalConfirm.addEventListener('click', () => modalOverlay.classList.remove('active'));
    </script>
</body>
</html>

